{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{% block title %}{% endblock %}</title> {# Updated title #}
    <link rel="stylesheet" href="{% static 'vendors/feather/feather.css' %}">
    <link rel="stylesheet" href="{% static 'vendors/ti-icons/css/themify-icons.css' %}">
    <link rel="stylesheet" href="{% static 'vendors/css/vendor.bundle.base.css' %}">
    <link rel="stylesheet" href="{% static 'vendors/datatables.net-bs4/dataTables.bootstrap4.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'js/select.dataTables.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/vertical-layout-light/style.css' %}">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">

    {# Add Font Awesome for icons #}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" type="text/css">
    {% comment %} {# Add Mapbox GL JS CSS #}
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet"> {% endcomment %}

    <!-- Leaflet CSS (Optional) -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <style>
        /* Map container */
        #mapid {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
            z-index: 1;
        }
        
        /* Bus markers */
        .bus-marker {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
        }
        
        .bus-marker i {
            font-size: 18px;
        }
        
        .bus-number {
            position: absolute;
            bottom: -15px;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: white;
            padding: 0 3px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        /* Status-specific colors */
        .bus-marker.active {
            background-color: #28a745; /* Green */
        }
        
        .bus-marker.in_maintenance {
            background-color: #ffc107; /* Yellow */
            color: #212529;
        }
        
        .bus-marker.out_of_commission {
            background-color: #dc3545; /* Red */
        }
        
        .bus-marker.delayed {
            background-color: #17a2b8; /* Teal */
        }
        
        .bus-marker.inactive {
            background-color: #6c757d; /* Gray */
        }
        
        /* School markers */
        .school-marker {
            color: #6610f2; /* Purple */
            font-size: 24px;
            text-align: center;
        }
        
        /* Map controls */
        .leaflet-control-layers {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }
        
        /* Live tracking controls */
        .live-tracking-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>
    {% block auth_content %}{% endblock auth_content %}
    <div class="container-scroller">
        {# Navbar - Visible for authenticated users #}
        {% if user.is_authenticated %}
        <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
                <a class="navbar-brand brand-logo mr-5" href="{% url 'core:dashboard' %}"><img src="{% static 'img/school_logo.png' %}" class="mr-2" alt="logo"/></a> {# Use Django URL #}
                <a class="navbar-brand brand-logo-mini" href="{% url 'core:dashboard' %}"><img src="{% static 'img/school_logo.png' %}" alt="logo"/></a> {# Use Django URL #}
            </div>
            <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
                <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
                <span class="icon-menu"></span>
                </button>
                <ul class="navbar-nav mr-lg-2">
                </ul>
                <ul class="navbar-nav navbar-nav-right">

                <li class="nav-item nav-profile dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" id="profileDropdown">
                        {# Use dynamic user name and image if available in context #}
                        <span class="mr-2 d-none d-lg-inline text-gray-600 small">{{ user.first_name|default:user.username }}</span>
                        <i class="fa-solid fa-user-circle fa-lg text-primary"></i> {# Font Awesome profile icon #}
                    </a>
                    <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="profileDropdown">
                        <form method="post" action="{% url 'core:logout' %}">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item">
                                <i class="fa-solid fa-sign-out-alt text-danger"></i> Logout
                            </button>
                        </form>
                    </div>
                </li>
                
                <li class="nav-item nav-settings d-none d-lg-flex">
                    <a class="nav-link" href="#">
                    <i class="icon-ellipsis"></i>
                    </a>
                </li>
                </ul>
                <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
                <span class="icon-menu"></span>
                </button>
            </div>
        </nav>
        {% endif %}

        <div class="container-fluid page-body-wrapper">
        {# Removed Settings panel and Right sidebar sections #}

        {# Sidebar - Visible for authenticated users #}
        {% if user.is_authenticated %}
        <nav class="sidebar sidebar-offcanvas" id="sidebar">
            <ul class="nav">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'core:dashboard' %}"> {# Use Django URL #}
                <i class="icon-grid menu-icon"></i>
                <span class="menu-title">Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="collapse" href="#ui-management" aria-expanded="false" aria-controls="ui-management">
                    <i class="icon-layout menu-icon"></i>
                    <span class="menu-title">Management</span>
                    <i class="menu-arrow"></i>
                </a>
                <div class="collapse" id="ui-management">
                    <ul class="nav flex-column sub-menu">
                        {% if user.role == 'admin' %}
                        <li class="nav-item"><a class="nav-link" href="{% url 'core:manage_schools' %}">Manage Schools</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'core:manage_buses' %}">Manage Buses</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'core:manage_routes' %}">Manage Routes</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'core:manage_users' %}">Manage Users</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'core:manage_students' %}">Manage Students</a></li>
                        {% endif %}
                        {% if user.role != 'driver' %}
                        <li class="nav-item"><a class="nav-link" href="{% url 'core:bus_tracking' %}">Bus Tracking</a></li>
                        {% endif %}
                        {% if user.role == 'driver' %}
                        <li class="nav-item"><a class="nav-link" href="#">My Trip</a></li>
                        {% endif %}
                    </ul>
                </div>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="collapse" href="#ui-communication" aria-expanded="false" aria-controls="ui-communication"> {# Changed ID #}
                <i class="icon-mail menu-icon"></i> {# Using mail icon #}
                <span class="menu-title">Communication</span> {# Changed title #}
                <i class="menu-arrow"></i>
                </a>
                <div class="collapse" id="ui-communication"> {# Changed ID #}
                <ul class="nav flex-column sub-menu">
                    <li class="nav-item"> <a class="nav-link" href="{% url 'core:user_notifications' %}">Notifications</a></li> {# Use Django URL #}
                    <li class="nav-item"> <a class="nav-link" href="{% url 'core:user_concerns' %}">View Concerns</a></li> {# Use Django URL #}
                    <li class="nav-item"> <a class="nav-link" href="{% url 'core:raise_concern' %}">Raise Concern</a></li> {# Use Django URL #}
                </ul>
                </div>
            </li>
            {# Removed unused menu items #}
            </ul>
        </nav>
        {% endif %}

        <div class="main-panel">
            <div class="content-wrapper">
            {% comment %} Display messages {% endcomment %}
            {% if messages %}
            <div class="container-fluid mt-3">
            {% for message in messages %}
            <div class="alert alert-dismissible fade show alert-{{ message.tags }}" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            </div>
            {% endif %}


{% block content %} {% endblock %}

</div>
<footer class="footer">
<div class="d-sm-flex justify-content-center justify-content-sm-between">
    <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright © {% now "Y" %}. School Bus Management System. All rights reserved.</span> {# Updated copyright #}
</div>
</footer>
</div>
</div>
</div>
    <script src="{% static 'vendors/js/vendor.bundle.base.js' %}"></script>
    <script src="{% static 'vendors/chart.js/Chart.min.js' %}"></script>
    <script src="{% static 'vendors/datatables.net/jquery.dataTables.js' %}"></script>
    <script src="{% static 'vendors/datatables.net-bs4/dataTables.bootstrap4.js' %}"></script>
    <script src="{% static 'js/dataTables.select.min.js' %}"></script>

    <script src="{% static 'js/off-canvas.js' %}"></script>
    <script src="{% static 'js/hoverable-collapse.js' %}"></script>
    <script src="{% static 'js/template.js' %}"></script>
    <script src="{% static 'js/settings.js' %}"></script>
    <script src="{% static 'js/todolist.js' %}"></script>
    {% comment %} <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js "></script> {% endcomment %}

    <!-- Leaflet JS (Optional) -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
    ></script>
    {% block extra_js %}
    {% endblock %}
</body>

</html>
